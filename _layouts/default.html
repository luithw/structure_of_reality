<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{{ site.description }}">
    <meta name="author" content="{{ site.author }}">
    <title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>
    
    <!-- Open Graph for social media -->
    <meta property="og:title" content="{% if page.title %}{{ page.title }}{% else %}{{ site.title }}{% endif %}">
    <meta property="og:description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">
    <meta property="og:type" content="{% if page.date %}article{% else %}website{% endif %}">
    <meta property="og:url" content="{{ page.url | absolute_url }}">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% if page.title %}{{ page.title }}{% else %}{{ site.title }}{% endif %}">
    <meta name="twitter:description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">
    
    <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
    <link rel="alternate" type="application/rss+xml" title="{{ site.title }}" href="{{ '/feed.xml' | relative_url }}">
    
    <!-- Firebase SDK for User Authentication -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>
    <header class="site-header">
        <div class="wrapper header-wrapper">
            <div class="header-left">
                <a class="site-title" href="{{ '/' | relative_url }}">{{ site.title }}</a>
                <p class="site-subtitle">{{ site.description }}</p>
                <nav class="site-nav">
                    <a href="{{ '/' | relative_url }}">Home</a>
                    <a href="{{ '/about/' | relative_url }}">About</a>
                    <a href="{{ '/archive/' | relative_url }}">Archive</a>
                </nav>
            </div>
            <div class="header-right">
                <div class="user-account" id="user-account">
                    <button class="auth-button" id="login-btn" onclick="openAuthModal()">Sign In</button>
                    <div class="user-menu" id="user-menu" style="display: none;">
                        <span class="user-name" id="user-name"></span>
                        <button class="auth-button logout" onclick="signOutUser()">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Auth Modal -->
    <div class="auth-modal" id="auth-modal">
        <div class="auth-modal-content">
            <span class="auth-close" onclick="closeAuthModal()">&times;</span>
            <h2 id="auth-title">Sign In</h2>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('signin')">Sign In</button>
                <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>
            <form id="auth-form" onsubmit="handleAuthSubmit(event)">
                <input type="email" id="auth-email" placeholder="Email" required>
                <input type="password" id="auth-password" placeholder="Password" required>
                <input type="password" id="auth-confirm-password" placeholder="Confirm Password" style="display: none;">
                <button type="submit" class="auth-submit" id="auth-submit-btn">Sign In</button>
            </form>
            <div class="auth-divider"><span>or</span></div>
            <button class="auth-google" onclick="signInWithGoogle()">
                <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 3.58c1.32 0 2.5.45 3.44 1.35l2.58-2.59a8 8 0 0 0-12.17 2.07L4.5 6.48A4.8 4.8 0 0 1 8.98 3.58z"/></svg>
                Continue with Google
            </button>
            <p class="auth-error" id="auth-error"></p>
        </div>
    </div>

    <main class="page-content">
        <div class="wrapper">
            {{ content }}
        </div>
    </main>

    <footer class="site-footer">
        <div class="wrapper">
            <!-- Newsletter Subscription -->
            <div class="newsletter-section">
                <h3>ðŸ“¬ Subscribe to Newsletter</h3>
                <p>Get notified when I publish new articles. No spam, unsubscribe anytime.</p>
                <form class="newsletter-form" action="https://buttondown.email/api/emails/embed-subscribe/{{ site.buttondown_username | default: 'structureofreality' }}" method="post" target="popupwindow" onsubmit="window.open('https://buttondown.email/{{ site.buttondown_username | default: 'structureofreality' }}', 'popupwindow')">
                    <input type="email" name="email" placeholder="Enter your email" required>
                    <button type="submit">Subscribe</button>
                </form>
                <p class="newsletter-note">Powered by <a href="https://buttondown.email" target="_blank">Buttondown</a></p>
            </div>
            
            <div class="footer-main">
                <p>{{ site.description }}</p>
                <p class="copyright">&copy; {{ 'now' | date: "%Y" }} {{ site.author }}. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Firebase Auth Script -->
    <script>
        // Firebase configuration - Replace with your Firebase project config
        const firebaseConfig = {
            apiKey: "{{ site.firebase_api_key | default: 'YOUR_API_KEY' }}",
            authDomain: "{{ site.firebase_auth_domain | default: 'YOUR_PROJECT.firebaseapp.com' }}",
            projectId: "{{ site.firebase_project_id | default: 'YOUR_PROJECT_ID' }}",
            storageBucket: "{{ site.firebase_storage_bucket | default: 'YOUR_PROJECT.appspot.com' }}",
            messagingSenderId: "{{ site.firebase_messaging_sender_id | default: 'YOUR_SENDER_ID' }}",
            appId: "{{ site.firebase_app_id | default: 'YOUR_APP_ID' }}"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        let currentAuthMode = 'signin';

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            const loginBtn = document.getElementById('login-btn');
            const userMenu = document.getElementById('user-menu');
            const userName = document.getElementById('user-name');

            if (user) {
                loginBtn.style.display = 'none';
                userMenu.style.display = 'flex';
                userName.textContent = user.displayName || user.email.split('@')[0];
            } else {
                loginBtn.style.display = 'block';
                userMenu.style.display = 'none';
            }
        });

        // Modal functions
        function openAuthModal() {
            document.getElementById('auth-modal').style.display = 'flex';
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').style.display = 'none';
            document.getElementById('auth-error').textContent = '';
        }

        function switchAuthTab(mode) {
            currentAuthMode = mode;
            const tabs = document.querySelectorAll('.auth-tab');
            const confirmPassword = document.getElementById('auth-confirm-password');
            const submitBtn = document.getElementById('auth-submit-btn');
            const title = document.getElementById('auth-title');

            tabs.forEach(tab => tab.classList.remove('active'));
            
            if (mode === 'signin') {
                tabs[0].classList.add('active');
                confirmPassword.style.display = 'none';
                submitBtn.textContent = 'Sign In';
                title.textContent = 'Sign In';
            } else {
                tabs[1].classList.add('active');
                confirmPassword.style.display = 'block';
                submitBtn.textContent = 'Sign Up';
                title.textContent = 'Create Account';
            }
        }

        async function handleAuthSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');
            
            try {
                if (currentAuthMode === 'signin') {
                    await auth.signInWithEmailAndPassword(email, password);
                } else {
                    const confirmPassword = document.getElementById('auth-confirm-password').value;
                    if (password !== confirmPassword) {
                        errorEl.textContent = 'Passwords do not match';
                        return;
                    }
                    await auth.createUserWithEmailAndPassword(email, password);
                }
                closeAuthModal();
            } catch (error) {
                errorEl.textContent = error.message;
            }
        }

        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
                closeAuthModal();
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        }

        async function signOutUser() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('auth-modal');
            if (event.target === modal) {
                closeAuthModal();
            }
        }
    </script>

    <!-- Local Timezone Conversion -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.local-time').forEach(function(timeEl) {
                const datetime = timeEl.getAttribute('datetime');
                if (datetime) {
                    const date = new Date(datetime);
                    const options = {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    };
                    timeEl.textContent = date.toLocaleString(undefined, options);
                }
            });
        });
    </script>
</body>
</html>

